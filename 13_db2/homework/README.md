# Практическая работа, модуль 13

## Цели практической работы

* Попрактиковаться в работе с инструкциями INSERT, UPDATE и DELETE.
* Познакомиться с понятием SQL-инъекции, научиться их делать и избегать с помощью параметризованных запросов.
* Освоить базовые принципы решения задач на заполнение таблиц данными по определённым условиям.

## Что входит в практическую работу

1. Перевозка вакцины.
2. Избавление от штрафов.
3. Журнал птиц.
4. Эффективный менеджер.
5. Жеребьёвка УЕФА.
6. Завод «Дружба».
7. Делаем инъекцию.

Перед выполнением работы запустите скрипт `generate_hw_database.py`. После выполнения скрипта у вас должен появиться
файл базы данных `homework.db` со всеми необходимыми таблицами для решения задач.

## Задача 1. Перевозка вакцины

### Что нужно сделать

Грузовик перевозит очень важную вакцину.

Условия хранения этой вакцины весьма необычные — в отсеке должна быть температура -18 ± 2 градуса. Если температурный
режим был нарушен, вакцина считается испорченной.

Для проверки состояния вакцины применяется датчик, который раз в час измеряет температуру внутри контейнера. Если
температура в контейнере была вне указанной хотя бы три часа, температурный режим считается нарушенным.

Реализуйте функцию, которая по номеру грузовика определяет, испортилась ли вакцина, с помощью
таблицы `table_truck_with_vaccine`.

```python
def check_if_vaccine_has_spoiled(
        cursor: sqlite3.Cursor,
        truck_number: str
) -> bool:
    ...
```

### Советы и рекомендации

* [Оператор BETWEEN](https://www.sqlitetutorial.net/sqlite-between/)
* [Оператор EXISTS](https://www.sqlitetutorial.net/sqlite-exists/)

### Что оценивается

Определение испорченности вакцины происходит через выборку с условием.

## Задача 2. Избавление от штрафов

### Что нужно сделать

Вы работаете программистом в IT-отделе ГИБДД. Ваш отдел отвечает за обслуживание камер, которые фиксируют превышение
скорости и выписывают автоматические штрафы.

За последний месяц к вам пришло больше тысячи жалоб на ошибочно назначенные штрафы, из которых около 100 были
действительно ошибочными.

Реализуйте функцию, которая по названию CSV-файла с данными об ошибочных штрафах удалит записи о них из
таблицы `table_fees`.

Список из дат и номеров автомобилей ошибочных штрафов хранится в файле `wrong_fees.csv`.

```python
def delete_wrong_fees(
        cursor: sqlite3.Cursor,
        wrong_fees_file: str
) -> None:
    ...
```

### Советы и рекомендации

[Модуль CSV](https://docs.python.org/3/library/csv.html)

### Что оценивается

Удаление происходит по совпадению и номера, и даты.

## Задача 3. Журнал птиц

### Что нужно сделать

Юный натуралист Петя решил посетить Юнтоловский заказник на рассвете и записать в журнал всех птиц, которых увидел в
заказнике. Он написал программу, но в процессе так устал, что уснул на клавиатуре, поэтому половина программы стёрлась.

Петя точно помнит, что программа позволяла добавить в БД новую птицу и говорила, видел ли он её раньше.

Помогите восстановить исходный код программы _ЮНат v0.1_, реализовав функции `log_bird` (добавление новой птицы в БД)
и `check_if_such_bird_already_seen` (уже видел такую птицу).

```python
def log_bird(
        cursor: sqlite3.Cursor,
        bird_name: str,
        date_time: str,
) -> None:
    ...


def check_if_such_bird_already_seen(
        cursor: sqlite3.Cursor,
        bird_name: str
) -> bool:
    ...
```

### Советы и рекомендации

[Оператор EXISTS](https://www.sqlitetutorial.net/sqlite-exists/)

### Что оценивается

Для определения наличия птицы в БД не используется получение списка всех записей.

## Задача 4. Эффективный менеджер

### Что нужно сделать

Иван Совин — эффективный менеджер. Когда к нему приходит сотрудник, чтобы просить повышение з/п, Иван может повысить её
только на 10%.

Если з/п сотрудника будет больше з/п Ивана Совина, сотрудника уволят. Если з/п сотрудника при увеличении не превысит з/п
Ивана, то з/п сотрудника повышают.

Помогите Ивану стать ещё эффективнее, автоматизировав его нелёгкий труд. Реализуйте функцию, которая по имени сотрудника
либо повышает его з/п, либо увольняет его (удаляет запись о нём из БД).

Таблица с данными называется `table_effective_manager`.

```python
def ivan_sovin_the_most_effective(
        cursor: sqlite3.Cursor,
        name: str,
) -> None:
    ...
```

### Советы и рекомендации

[Оператор LIKE](https://www.sqlitetutorial.net/sqlite-like/)

### Что оценивается

* Зарплата Ивана Совина вынесена в константу.
* Эффективный менеджер не удаляется из БД.

## Задача 5. Жеребьёвка УЕФА

### Что нужно сделать

Глава УЕФА попросил вас провести жеребьёвку команд для предстоящего Чемпионата Европы.

Имеется N групп. В каждую группу попадают:

* одна сильная команда;
* две средние команды;
* одна слабая команда.

Реализуйте функцию, которая по количеству групп (от 4 до 16) генерирует данные, которыми заполняются две таблицы:

1. Таблица со списком команд (`uefa_commands`):

   `№ команды | название | страна | уровень команды`
3. Таблица с результатами жеребьевки (`uefa_draw`):

   `№ команды | № группы`

```python
def generate_test_data(
        cursor: sqlite3.Cursor,
        number_of_groups: int
) -> None:
    ...
```

### Советы и рекомендации

Метод [executemany](https://docs.python.org/3/library/sqlite3.html#sqlite3.Cursor.executemany) объекта `Cursor`
позволяет исполнить SQL-запрос с набором данных без использования цикла.

### Что оценивается

* Программа корректно заполняет любое количество групп от 4 до 16.
* Названия команд уникальны.
* Соблюдено условие распределения по уровням.

## Задача 6. Завод «Дружба»

### Что нужно сделать

На заводе «Дружба» дружный коллектив. Сотрудники работают посменно, в смене десять человек. Всего 366 рабочих.

Бухгалтер завода составила расписание смен на 366 дней и занесла его в БД в таблицу `table_friendship_schedule`, но не
учла тот факт, что все сотрудники ходят на различные спортивные кружки:

* понедельник — футбол;
* вторник — хоккей;
* среда — шахматы;
* четверг — SUP-сёрфинг;
* пятница — бокс;
* суббота — Dota2;
* воскресенье — шахбокс.

Нельзя выходить на работу в день тренировки: сотрудник, занимающийся шахматами, не может работать в среду, а его
коллега-боксёр — не может в пятницу.

Помогите изменить расписание смен с учётом личных предпочтений рабочих.

```python
def update_work_schedule(cursor: sqlite3.Cursor) -> None:
    ...
```

Подумайте, при каких данных невозможно составить расписание.

### Советы и рекомендации

* На первый взгляд задача может показаться сложной, но в ней всего одно жёсткое условие — _нельзя выходить на работу в
  день тренировки_. Нужно лишь проявить творчество в составлении расписания.
* Для очистки таблицы можно воспользоваться следующим запросом:

  ```
  DELETE FROM `table_name`
  ```

### Что оценивается

* Количество вложенных циклов минимально. Постарайтесь, чтобы сложность вашего алгоритма не превышала O(NlogN + MlogM),
  где N и M — количество сотрудников и рабочих дней соответственно. О том, что такое O большое, можно почитать в
  статьях [Big O](https://habr.com/ru/post/444594/)
  и [«Сложность алгоритмов. Big O. Основы»](https://bimlibik.github.io/posts/complexity-of-algorithms/).
* Задействована большая часть работников.

## Задача 7. Делаем инъекцию

### Что нужно сделать

Мы часто говорили о важности параметризованных запросов и упоминали понятие SQL-инъекции. Давайте взглянем на это со
стороны хакера.

В таблице `table_users` имена и пароли пользователей. Также есть функция `register`, она регистрирует пользователя,
добавляя запись в эту таблицу. Функцию писал неопытный и наивный программист, поэтому в ней есть уязвимые места.

```python
import sqlite3


def register(username: str, password: str) -> None:
    with sqlite3.connect('../homework.db') as conn:
        cursor: sqlite3.Cursor = conn.cursor()
        cursor.executescript(
            f"""
                INSERT INTO `table_users` (username, password)
                VALUES ('{username}', '{password}')  
                """
        )
        conn.commit()
```

Ваша задача — задать переменным `username` и `password` в функции `hack` такие значения, чтобы с таблицей произошло
нечто страшное. Например, её удаление или добавление очень большого количества новых записей.

```python
def hack():
    username: str = "i_like"
    password: str = "sql_injection"
    register(username, password)
```

### Советы и рекомендации

* [Методы execute, executemany и executescript](https://docs.python.org/3/library/sqlite3.html#sqlite3.Cursor)
* Подумайте, какие две основные ошибки допустил неопытный программист в функции `register`.

### Что оценивается

* Для взлома используются только строковые значения переменных username и password.
* Таблица претерпела серьёзные изменения, которые дали неопытному программисту ценный урок в виде:
    * удаления таблицы или записей;
    * изменения существующих записей;
    * добавления большого числа новых записей;
    * [изменения схемы таблицы](https://www.sqlitetutorial.net/sqlite-alter-table/).

## Общие советы и рекомендации

* Список основных функций SQL можно найти здесь:
    * [скалярные функции](https://www.sqlite.org/lang_corefunc.html)
    * [агрегирующие функции](https://www.sqlite.org/lang_aggfunc.html#aggfunclist)
    * [математические функции](https://www.sqlite.org/lang_mathfunc.html)
* [Сайт с упражнениями по SQL](https://sql-ex.ru/)
* [SQL injection для начинающих](https://habr.com/ru/post/148151/)

## Что оценивается в практической работе

* Используются параметризованные запросы.
* Используется максимум возможностей SQL-запросов.
* Для вставки, изменения или удаления набора данных используется метод `executemany`, а не `execute` в цикле.
* Наличие записи в таблице определяется с помощью `COUNT` или `EXISTS`.
* Названия переменных, функций и классов имеют значащие имена.
